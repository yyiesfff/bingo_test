<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 ğŸ ç¦é©è³€æ­²è³“æœç³»çµ± V19.0 - å¯¦æ™‚å¤šäººç‰ˆ</title>
    
    <!-- [Firebase ä½¿ç”¨ REST API - ç„¡éœ€ SDK] -->
    
    <style>
        /* [CONFIG - è¨­å®šä¸­å¿ƒ] */
        :root { 
            --paper-red: #b30000;      --bright-red: #d32f2f;     
            --gold: #ffcf33;           --dark-gold: #b8860b;      
            --ui-width: 350px;         
            --board-scale: 0.65;       /* [é–å®š] ç¸®å°æ¯”ä¾‹ 65% */
            --aligned-width: calc(var(--ui-width) * var(--board-scale)); /* å°é½Šå¯¬åº¦ */
        }

        body { 
            margin: 0; 
            background: radial-gradient(circle, #8b0000 0%, #4a0000 100%); 
            color: var(--gold); 
            font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            min-height: 100vh; 
            overflow-x: hidden; 
        }
        
        /* [UI - ç™»å…¥é é¢] */
        .login-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            gap: 20px;
            padding: 20px;
        }
        
        .login-box {
            background: rgba(0,0,0,0.6);
            border: 3px solid var(--gold);
            border-radius: 15px;
            padding: 40px;
            max-width: 400px;
            width: 100%;
            text-align: center;
        }
        
        .login-title {
            font-size: 32px;
            font-weight: bold;
            color: var(--gold);
            margin-bottom: 30px;
            text-shadow: 0 0 10px rgba(255,207,51,0.5);
        }
        
        .login-input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 2px solid var(--gold);
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
            color: var(--gold);
            font-size: 16px;
            box-sizing: border-box;
            font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif;
        }
        
        .login-input::placeholder {
            color: rgba(255,207,51,0.5);
        }
        
        .login-input:focus {
            outline: none;
            box-shadow: 0 0 15px rgba(255,207,51,0.5);
            background: rgba(255,255,255,0.15);
        }
        
        .login-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(to bottom, var(--gold), #ffaa00);
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            color: #8b0000;
            cursor: pointer;
            box-shadow: 0 4px 0 var(--dark-gold);
            transition: 0.1s;
            font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif;
        }
        
        .login-btn:active {
            transform: scale(0.95);
            box-shadow: 0 2px 0 var(--dark-gold);
        }
        
        /* [UI - æœƒè©± ID è¼¸å…¥åˆ†éš”] */
        .login-divider {
            margin: 20px 0;
            text-align: center;
            color: var(--gold);
            font-size: 12px;
            position: relative;
        }
        
        .login-divider::before,
        .login-divider::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 35%;
            height: 1px;
            background: var(--gold);
        }
        
        .login-divider::before {
            left: 0;
        }
        
        .login-divider::after {
            right: 0;
        }
        
        .session-input {
            width: 100%;
            padding: 12px;
            margin-bottom: 10px;
            border: 2px solid var(--gold);
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
            color: var(--gold);
            font-size: 14px;
            box-sizing: border-box;
            font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif;
        }
        
        .session-input::placeholder {
            color: rgba(255,207,51,0.5);
        }
        
        .session-input:focus {
            outline: none;
            box-shadow: 0 0 15px rgba(255,207,51,0.5);
            background: rgba(255,255,255,0.15);
        }
        
        .session-btn {
            width: 100%;
            padding: 10px;
            background: rgba(255,207,51,0.2);
            border: 1px solid var(--gold);
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            color: var(--gold);
            cursor: pointer;
            transition: 0.2s;
            font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif;
            margin-bottom: 15px;
        }
        
        .session-btn:hover {
            background: rgba(255,207,51,0.3);
        }
        
        .session-btn:active {
            transform: scale(0.95);
        }
        
        .previous-users {
            margin-top: 30px;
            width: 100%;
        }
        
        .previous-users-title {
            font-size: 14px;
            color: var(--gold);
            margin-bottom: 10px;
            border-bottom: 1px solid var(--gold);
            padding-bottom: 10px;
        }
        
        .user-button {
            width: 100%;
            padding: 10px;
            margin-bottom: 8px;
            background: rgba(255,207,51,0.1);
            border: 1px solid var(--gold);
            border-radius: 6px;
            color: var(--gold);
            cursor: pointer;
            font-size: 14px;
            transition: 0.2s;
            font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif;
        }
        
        .user-button:hover {
            background: rgba(255,207,51,0.2);
            transform: scale(1.02);
        }
        
        .hidden { display: none !important; }
        
        /* [UI - ç‡ˆç± å‹•ç•«] å­ç‘œèª¿æ•´ï¼šé«˜åº¦ 50px, é–“è· 80px */
        .lantern-container { position: fixed; top: 50px; width: 100%; display: flex; justify-content: center; gap: 80px; pointer-events: none; z-index: 100; }
        .lantern-box { animation: sway 1.2s ease-in-out infinite alternate; transform-origin: top center; filter: drop-shadow(0 0 20px rgba(255, 207, 51, 0.6)); }
        .lantern-svg { width: 130px; height: 220px; overflow: visible; }
        @keyframes sway { from { transform: rotate(-12deg); } to { transform: rotate(12deg); } }
        .tassels-group { animation: counter-sway 1.2s ease-in-out infinite alternate; transform-origin: 50% 115px; }
        .tassel-strand { stroke: var(--gold); stroke-width: 2.5; stroke-linecap: round; fill: none; }
        @keyframes counter-sway { from { transform: rotate(12deg); } to { transform: rotate(-12deg); } }

        .view-section { display: flex; flex-direction: column; align-items: center; width: 100%; padding-bottom: 50px; }
        
        /* [UI - ç”¨æˆ¶é ­éƒ¨æ¬„] */
        .user-header {
            width: 100%;
            background: rgba(0,0,0,0.4);
            border-bottom: 2px solid var(--gold);
            padding: 12px 0;
            text-align: center;
            display: flex;
            justify-content: space-around;
            align-items: center;
        }
        
        .user-info {
            font-size: 14px;
            color: var(--gold);
        }
        
        .logout-btn {
            padding: 6px 12px;
            background: rgba(255,207,51,0.2);
            border: 1px solid var(--gold);
            border-radius: 6px;
            color: var(--gold);
            cursor: pointer;
            font-size: 12px;
            transition: 0.2s;
            font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif;
        }
        
        .logout-btn:hover {
            background: rgba(255,207,51,0.3);
        }
        
        /* [UI - éŠæˆ²æœƒè©±è³‡è¨Š] */
        .session-info {
            background: rgba(179,0,0,0.3);
            border: 1px solid var(--gold);
            border-radius: 8px;
            padding: 12px;
            margin: 15px 0;
            width: var(--aligned-width);
            box-sizing: border-box;
            text-align: center;
            font-size: 12px;
        }
        
        .session-id {
            background: rgba(0,0,0,0.5);
            padding: 6px 8px;
            border-radius: 4px;
            margin: 8px 0;
            font-family: 'Courier New', monospace;
            word-break: break-all;
            cursor: pointer;
            user-select: all;
        }
        
        .session-id:hover {
            background: rgba(255,207,51,0.2);
        }
        
        .copy-btn {
            background: rgba(255,207,51,0.2);
            border: 1px solid var(--gold);
            color: var(--gold);
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            margin-left: 8px;
            transition: 0.2s;
        }
        
        .copy-btn:hover {
            background: rgba(255,207,51,0.4);
        }
        
        .players-list {
            background: rgba(0,0,0,0.4);
            border: 1px solid var(--gold);
            border-radius: 8px;
            padding: 10px;
            margin: 15px 0;
            width: var(--aligned-width);
            box-sizing: border-box;
        }
        
        .players-title {
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 8px;
            color: var(--gold);
        }
        
        .player-item {
            background: rgba(255,207,51,0.1);
            padding: 6px 8px;
            margin-bottom: 6px;
            border-radius: 4px;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* [UI - é‡æ–°é–‹å§‹éµ] å°é½Š 25 æ ¼å¯¬åº¦ (65%) */
        .main-btn { 
            width: var(--aligned-width); padding: 12px; 
            background: linear-gradient(to bottom, var(--gold), #ffaa00); 
            border: none; border-radius: 50px; 
            font-size: 16px; font-weight: bold; color: #8b0000; 
            cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 5px; 
            box-shadow: 0 4px 0 var(--dark-gold); transition: 0.1s; 
            text-decoration: none;
        }
        .main-btn:active { transform: scale(0.95); box-shadow: 0 2px 0 var(--dark-gold); }

        .current-num { font-size: 90px; font-weight: 900; color: #fff; text-shadow: 0 0 20px var(--gold); margin: 5px 0; }
        
        /* [UI] 25æ ¼ç´…è‰²å€åŸŸ (65%) */
        .bingo-board { 
            display: grid; grid-template-columns: repeat(5, 1fr); 
            gap: 5px; 
            background: linear-gradient(135deg, var(--gold), var(--dark-gold)); 
            padding: 8px; border-radius: 8px; 
            width: var(--aligned-width); 
            margin: 15px 0; box-sizing: border-box; 
        }

        .cell { 
            background: var(--paper-red); aspect-ratio: 1/1; 
            display: flex; justify-content: center; align-items: center; 
            font-size: 15px; font-weight: bold; color: var(--gold); 
            border-radius: 4px; position: relative; border: 1px solid rgba(255,207,51,0.4); 
        }
        .cell.marked .stamp-svg { opacity: 0.65; transform: scale(1) rotate(-15deg); }
        .stamp-svg { position: absolute; width: 90%; height: 90%; opacity: 0; transform: scale(2); transition: 0.3s; pointer-events: none; z-index: 5; }
        
        /* [UI - å·²é–‹è™Ÿç´€éŒ„æ¬„ä½] å°é½Š 25 æ ¼å¯¬åº¦ (65%) */
        .align-panel { 
            width: var(--aligned-width); 
            background: rgba(0,0,0,0.4); border: 2px solid var(--gold); border-radius: 10px; 
            padding: 10px; box-sizing: border-box; margin-bottom: 15px; 
        }
        .panel-title { 
            font-size: 12px; font-weight: 900; color: var(--gold); 
            border-bottom: 1px solid var(--gold); margin-bottom: 8px; 
            display: flex; align-items: center; gap: 5px; 
        }

        /* [UI] å…ƒå¯¶æŒ‰éˆ• (å­ç‘œèª¿æ•´ï¼šç¸®å°è‡³ 75%, é«˜åº¦åŒæ­¥) */
        .ingot-btn { 
            background: none; border: none; cursor: pointer; position: relative; 
            width: calc(var(--ui-width) * 0.75); 
            height: 82.5px; 
            display: flex; justify-content: center; align-items: center; transition: 0.1s; 
        }
        .ingot-btn svg { position: absolute; top:0; left:0; width:100%; height:100%; z-index: 1; }
        .ingot-btn span { 
            position: relative; z-index: 2; color: #8b0000; font-weight: bold; 
            font-size: 18px; margin-top: 15px; 
        }
        .ingot-btn:disabled { opacity: 0.5; filter: grayscale(1); }
    </style>
</head>
<body onload="App.Actions.initApp()">

    <!-- [ç™»å…¥é é¢] -->
    <div class="login-container" id="loginView">
        <div class="login-box">
            <div class="login-title">ğŸ§§ ç¦é©è³“æœ ğŸ§§</div>
            <p style="color: var(--gold); margin-bottom: 20px;">è«‹è¼¸å…¥ä½ çš„åç¨±é–‹å§‹éŠæˆ²</p>
            <input 
                type="text" 
                class="login-input" 
                id="usernameInput" 
                placeholder="è¼¸å…¥ä½ çš„åç¨±..." 
                onkeypress="if(event.key==='Enter') App.Actions.login()"
            >
            <button class="login-btn" onclick="App.Actions.login()">é€²å…¥éŠæˆ² ğŸ®</button>
            
            <!-- è¼¸å…¥æœƒè©± ID å€å¡Š -->
            <div class="login-divider">æˆ–</div>
            <p style="color: var(--gold); margin: 10px 0; font-size: 12px;">è¼¸å…¥æœƒè©± ID åŠ å…¥ç¾å­˜éŠæˆ²</p>
            <input 
                type="text" 
                class="session-input" 
                id="sessionIdInput" 
                placeholder="è²¼ä¸Šæœƒè©± ID (ä¾‹: session_xxx)" 
                onkeypress="if(event.key==='Enter') App.Actions.joinBySessionId()"
            >
            <button class="session-btn" onclick="App.Actions.joinBySessionId()">ğŸ¯ åŠ å…¥éŠæˆ²</button>
            
            <div class="previous-users" id="previousUsersContainer" style="display:none;">
                <div class="previous-users-title">ğŸ“‹ æœ€è¿‘ç©å®¶</div>
                <div id="previousUsersList"></div>
            </div>
        </div>
    </div>

    <!-- [éŠæˆ²é é¢] -->
    <div class="hidden" id="gameView">
        <!-- ç”¨æˆ¶é ­éƒ¨ -->
        <div class="user-header">
            <div class="user-info">ğŸ® ç©å®¶: <strong id="currentUsername">-</strong></div>
            <button class="logout-btn" onclick="App.Actions.logout()">ç™»å‡º</button>
        </div>

        <div class="lantern-container">
            <div class="lantern-box">
                <svg class="lantern-svg" viewBox="0 0 100 200">
                    <ellipse cx="50" cy="60" rx="40" ry="55" fill="#d32f2f" stroke="#ffcf33" stroke-width="3"/>
                    <text x="50" y="65" writing-mode="vertical-rl" text-orientation="upright" font-weight="900" font-size="40" fill="#ffcf33" text-anchor="middle">ç¦é©</text>
                    <g class="tassels-group">
                        <path d="M50 115 Q 50 145, 50 175" class="tassel-strand" stroke-width="4"/>
                        <path d="M45 115 Q 42 145, 40 170" class="tassel-strand"/>
                        <path d="M55 115 Q 58 145, 60 170" class="tassel-strand"/>
                        <path d="M40 115 Q 35 140, 35 160" class="tassel-strand"/>
                        <path d="M60 115 Q 65 140, 65 160" class="tassel-strand"/>
                    </g>
                </svg>
            </div>
            <div class="lantern-box">
                <svg class="lantern-svg" viewBox="0 0 100 200">
                    <ellipse cx="50" cy="60" rx="40" ry="55" fill="#d32f2f" stroke="#ffcf33" stroke-width="3"/>
                    <text x="50" y="65" writing-mode="vertical-rl" text-orientation="upright" font-weight="900" font-size="40" fill="#ffcf33" text-anchor="middle">ç¦é©</text>
                    <g class="tassels-group">
                        <path d="M50 115 Q 50 145, 50 175" class="tassel-strand" stroke-width="4"/>
                        <path d="M45 115 Q 42 145, 40 170" class="tassel-strand"/>
                        <path d="M55 115 Q 58 145, 60 170" class="tassel-strand"/>
                        <path d="M40 115 Q 35 140, 35 160" class="tassel-strand"/>
                        <path d="M60 115 Q 65 140, 65 160" class="tassel-strand"/>
                    </g>
                </svg>
            </div>
        </div>

        <div class="view-section" style="margin-top:20px;">
            <h1 style="color:var(--gold); margin:0;">ğŸ§§ è²¡ ğŸ§§</h1>
            
            <!-- éŠæˆ²æœƒè©±è³‡è¨Š -->
            <div class="session-info">
                <div style="margin-bottom: 8px;">ğŸ“Œ éŠæˆ²æœƒè©±</div>
                <div class="session-id" id="sessionIdDisplay" title="é»æ“Šè¤‡è£½">è¼‰å…¥ä¸­...</div>
                <button class="copy-btn" onclick="App.Actions.copySessionId()">ğŸ“‹ è¤‡è£½</button>
                <div style="margin-top: 6px; font-size: 11px; color: rgba(255,207,51,0.7);">åˆ†äº«æœƒè©± ID çµ¦å…¶ä»–ç©å®¶åŠ å…¥æœ¬å±€</div>
            </div>
            
            <!-- ç·šä¸Šç©å®¶åˆ—è¡¨ -->
            <div class="players-list" id="playersList" style="display: none;">
                <div class="players-title">ğŸ‘¥ ç·šä¸Šç©å®¶ (<span id="playerCount">1</span>)</div>
                <div id="playersContainer"></div>
            </div>
            
            <div class="current-num" id="displayNum">?</div>

            <div id="actionArea" style="display:flex; flex-direction:column; align-items:center;">
                <button class="ingot-btn" id="drawBtn" onclick="App.Actions.draw()">
                    <svg viewBox="0 0 200 100"><path d="M20,60 Q20,90 100,90 Q180,90 180,60 Q180,30 150,30 Q140,10 100,10 Q60,10 50,30 Q20,30 20,60" fill="#ffcf33" stroke="#d4a017" stroke-width="3"/><circle cx="100" cy="45" r="20" fill="#ffd700" stroke="#d4a017" stroke-width="1"/></svg>
                    <span>ğŸ æŠ½çƒè™Ÿ</span>
                </button>
            </div>

            <div class="bingo-board" id="board"></div>

            <div class="align-panel">
                <div class="panel-title">å·²é–‹è™Ÿç¢¼ç´€éŒ„ (01-50)</div>
                <div id="historyList" style="display:flex; flex-wrap:wrap; gap:5px; justify-content:center;"></div>
            </div>
            
            <button class="main-btn" onclick="App.Actions.newGame()">
                ğŸ”„ é‡æ–°é–‹å§‹æ–°å±€
            </button>
        </div>
    </div>

    <script>
    /* ============================================================
        [æ¨¡çµ„ 1: è·¨è£ç½®å¯¦æ™‚åŒæ­¥ç³»çµ± - Firebase Realtime Database]
       ============================================================ */
    
    // Firebase é…ç½® (ä½¿ç”¨ REST API)
    const firebaseConfig = {
        apiKey: "AIzaSyB3OFFjxXqOniYRX9bPW122a2w99hzhJz8",
        authDomain: "bingo-game-18d7c.firebaseapp.com",
        databaseURL: "https://bingo-game-18d7c-default-rtdb.firebaseio.com",
        projectId: "bingo-game-18d7c",
        storageBucket: "bingo-game-18d7c.firebasestorage.app",
        messagingSenderId: "123802679742",
        appId: "1:123802679742:web:9a6968e831b2f8cda2a1ef",
        measurementId: "G-MV7DWYF5T5"
    };

    // åˆå§‹åŒ– Firebase (ä½¿ç”¨ REST APIï¼Œç„¡éœ€ SDK)
    let firebaseInitialized = false;
    
    function initFirebase() {
        try {
            // REST API ç„¡éœ€ SDKï¼Œç›´æ¥æª¢æŸ¥é…ç½®æœ‰æ•ˆæ€§
            if (firebaseConfig.apiKey && firebaseConfig.databaseURL && !firebaseConfig.apiKey.startsWith('AIzaSyDp_1234567890')) {
                firebaseInitialized = true;
                console.log('âœ… Firebase REST API å·²å°±ç·’ - æ”¯æŒè·¨ç€è¦½å™¨åŒæ­¥');
                console.log('ğŸ“ Firebase é…ç½®:', {
                    projectId: firebaseConfig.projectId,
                    databaseURL: firebaseConfig.databaseURL
                });
            } else {
                console.log('âš ï¸ Firebase é…ç½®ç„¡æ•ˆ - åªèƒ½ä½¿ç”¨æœ¬åœ°æ¨¡å¼ (åŒä¸€ç€è¦½å™¨å…§)');
            }
        } catch (error) {
            console.error('âŒ Firebase åˆå§‹åŒ–å¤±æ•—:', error.message);
            console.log('ğŸ”„ é™ç´šç‚ºæœ¬åœ°æ¨¡å¼ (LocalStorage)');
        }
    }
    
    const App = {
        Config: { MAX_NUM: 50 },

        /* [æ¨¡çµ„ 2: STATE - å…¨å±€ç‹€æ…‹å€‰åº«] */
        State: { 
            currentUser: null,
            participants: {},
            sharedDrawPool: [],
            sharedDrawnNums: [],
            isAnimating: false,
            gameOver: false,
            gameSessionId: null,  // ç•¶å‰éŠæˆ²æœƒè©± ID
            syncListeners: [],    // å­˜å„² Firebase ç›£è½å™¨ä»¥ä¾¿æ¸…ç†
            playerListInterval: null  // ç©å®¶åˆ—è¡¨æ›´æ–°çš„é—´éš” ID
        },

        /* [æ¨¡çµ„ 3: UTILS - å·¥å…·ç®±] */
        Utils: {
            fmt: (n) => n.toString().padStart(2, '0'),
            shuffle: (arr) => arr.sort(() => Math.random() - 0.5),
            generateSessionId: () => {
                return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            },
            
            getLineCount: (board, drawn) => {
                let g = Array(25).fill(false); 
                g[12] = true; 
                let k = 0;
                for(let i=0; i<25; i++) { 
                    if(i!==12) { 
                        if(drawn.includes(board[k++])) g[i] = true; 
                    }
                }
                const lines = [
                    [0,1,2,3,4],[5,6,7,8,9],[10,11,12,13,14],[15,16,17,18,19],[20,21,22,23,24],
                    [0,5,10,15,20],[1,6,11,16,21],[2,7,12,17,22],[3,8,13,18,23],[4,9,14,19,24],
                    [0,6,12,18,24],[4,8,12,16,20]
                ];
                return lines.filter(line => line.every(idx => g[idx])).length;
            }
        },

        /* [æ¨¡çµ„ 4: STORAGE - æœ¬åœ°å­˜å„²ç®¡ç†] */
        Storage: {
            saveUser: (username) => {
                const users = JSON.parse(localStorage.getItem('bingo_users') || '[]');
                if (!users.includes(username)) {
                    users.push(username);
                    localStorage.setItem('bingo_users', JSON.stringify(users));
                }
            },
            
            getUsers: () => {
                return JSON.parse(localStorage.getItem('bingo_users') || '[]');
            },
            
            saveGame: (username, gameData) => {
                const games = JSON.parse(localStorage.getItem('bingo_games') || '{}');
                games[username] = gameData;
                localStorage.setItem('bingo_games', JSON.stringify(games));
            },
            
            loadGame: (username) => {
                const games = JSON.parse(localStorage.getItem('bingo_games') || '{}');
                return games[username] || null;
            },
            
            saveSharedState: (state) => {
                localStorage.setItem('bingo_shared_state', JSON.stringify(state));
            },
            
            loadSharedState: () => {
                return JSON.parse(localStorage.getItem('bingo_shared_state') || '{"drawnNums":[], "drawPool":[], "participants":{}}');
            },
            
            saveParticipants: (participants, sessionId = null) => {
                // æŒ‰ Session ID åˆ†é–‹å­˜å„²ç©å®¶åˆ—è¡¨ï¼Œé¿å…ä¸åŒ session çš„ç©å®¶æ··æ·†
                const key = sessionId ? `bingo_participants_${sessionId}` : 'bingo_participants';
                localStorage.setItem(key, JSON.stringify(participants));
            },
            
            loadParticipants: (sessionId = null) => {
                // æŒ‰ Session ID åŠ è¼‰å°æ‡‰çš„ç©å®¶åˆ—è¡¨
                const key = sessionId ? `bingo_participants_${sessionId}` : 'bingo_participants';
                return JSON.parse(localStorage.getItem(key) || '{}');
            }
        },

        /* [æ¨¡çµ„ 5: FIREBASE REST API åŒæ­¥] */
        Firebase: {
            // åŒæ­¥éŠæˆ²ç‹€æ…‹åˆ°é›²ç«¯ (ä½¿ç”¨ REST API)
            syncToCloud: async (sessionId) => {
                if (!firebaseInitialized) return;
                
                try {
                    const url = `${firebaseConfig.databaseURL}/games/${sessionId}.json`;
                    
                    const gameData = {
                        gameSessionId: sessionId,
                        sharedDrawnNums: App.State.sharedDrawnNums,
                        sharedDrawPool: App.State.sharedDrawPool,
                        gameOver: App.State.gameOver,
                        participants: App.State.participants,
                        updatedAt: new Date().toISOString()
                    };
                    
                    const response = await fetch(url, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(gameData)
                    });
                    
                    if (response.ok) {
                        console.log('âœ… éŠæˆ²ç‹€æ…‹å·²åŒæ­¥åˆ° Firebase');
                    } else {
                        console.warn('âš ï¸ Firebase åŒæ­¥å›æ‡‰ç•°å¸¸:', response.status);
                    }
                } catch (error) {
                    console.log('âš ï¸ Firebase é›²ç«¯åŒæ­¥å¤±æ•— (é™ç´šç‚ºæœ¬åœ°æ¨¡å¼):', error.message);
                }
            },
            
            // ç›£è½é ç¨‹éŠæˆ²ç‹€æ…‹è®ŠåŒ– (å®šæœŸè¼ªè©¢ REST API)
            listenToGameChanges: (sessionId) => {
                if (!firebaseInitialized) return;
                
                // æ¯ 2 ç§’æª¢æŸ¥ä¸€æ¬¡é ç¨‹æ•¸æ“š
                const pollInterval = setInterval(async () => {
                    try {
                        const url = `${firebaseConfig.databaseURL}/games/${sessionId}.json`;
                        const response = await fetch(url);
                        
                        if (!response.ok) return;
                        
                        const remoteData = await response.json();
                        if (!remoteData) return;
                        
                        // æª¢æŸ¥æ˜¯å¦æ˜¯åˆ¥äººçš„æ›´æ–°
                        if (remoteData.sharedDrawnNums && remoteData.sharedDrawnNums.length > App.State.sharedDrawnNums.length) {
                            // æœ‰æ–°çš„è™Ÿç¢¼è¢«æŠ½å–
                            const newNum = remoteData.sharedDrawnNums[remoteData.sharedDrawnNums.length - 1];
                            App.State.sharedDrawnNums = remoteData.sharedDrawnNums;
                            App.State.sharedDrawPool = remoteData.sharedDrawPool;
                            
                            // æ›´æ–°æœ¬åœ°æ£‹ç›¤
                            document.querySelectorAll('.cell-num').forEach(s => { 
                                if(s.textContent === App.Utils.fmt(newNum)) s.parentElement.classList.add('marked'); 
                            });
                            
                            // æ›´æ–°æ­·å²
                            App.Actions.renderHistory();
                            
                            // æª¢æŸ¥æœ¬åœ°è´ç·š
                            App.Core.checkWin();
                        }
                        
                        // åŒæ­¥éŠæˆ²çµæŸç‹€æ…‹
                        if (remoteData.gameOver) {
                            App.State.gameOver = true;
                        }
                    } catch (error) {
                        // è¼ªè©¢éŒ¯èª¤ä¸å¼·è¡Œä¸­æ­¢ï¼Œåªè¨˜éŒ„
                        console.log('ğŸ“¡ Firebase è¼ªè©¢éŒ¯èª¤ï¼ˆå¯å¿½ç•¥ï¼‰:', error.message);
                    }
                }, 2000);
                
                App.State.syncListeners.push(() => clearInterval(pollInterval));
            },
            
            // ç›£è½ç©å®¶åˆ—è¡¨ (å®šæœŸè¼ªè©¢ REST API)
            listenToPlayers: (sessionId) => {
                if (!firebaseInitialized) return;
                
                // æ¯ 1 ç§’æª¢æŸ¥ä¸€æ¬¡ç©å®¶åˆ—è¡¨
                const pollInterval = setInterval(async () => {
                    try {
                        const url = `${firebaseConfig.databaseURL}/games/${sessionId}/participants.json`;
                        const response = await fetch(url);
                        
                        if (!response.ok) return;
                        
                        const remoteParticipants = await response.json();
                        if (!remoteParticipants) return;
                        
                        // åˆä½µè€Œä¸æ˜¯ç›´æ¥æ›¿æ›ï¼Œä¿ç•™æœ¬åœ°ç©å®¶ä¸¦æ›´æ–°é ç¨‹ç©å®¶
                        const mergedParticipants = { ...remoteParticipants, ...App.State.participants };
                        if (JSON.stringify(mergedParticipants) !== JSON.stringify(App.State.participants)) {
                            App.State.participants = mergedParticipants;
                            App.Actions.updatePlayersList();
                        }
                    } catch (error) {
                        // è¼ªè©¢éŒ¯èª¤ä¸å¼·è¡Œä¸­æ­¢
                        console.log('ğŸ“¡ ç©å®¶åˆ—è¡¨è¼ªè©¢éŒ¯èª¤ï¼ˆå¯å¿½ç•¥ï¼‰:', error.message);
                    }
                }, 1000);
                
                App.State.syncListeners.push(() => clearInterval(pollInterval));
            }
        },

        /* [æ¨¡çµ„ 6: UI - ç•«é¢æ¸²æŸ“å¸«] */
        UI: {
            updateHistory: (n) => {
                const d = document.createElement('div'); 
                d.style.cssText = "background:var(--paper-red); padding:1px 4px; border-radius:3px; border:1px solid var(--gold); color:#fff; font-weight:900; font-size:12px;";
                d.textContent = App.Utils.fmt(n); 
                document.getElementById('historyList').appendChild(d);
            },
            
            showLoginView: () => {
                document.getElementById('loginView').classList.remove('hidden');
                document.getElementById('gameView').classList.add('hidden');
            },
            
            showGameView: () => {
                document.getElementById('loginView').classList.add('hidden');
                document.getElementById('gameView').classList.remove('hidden');
                document.getElementById('currentUsername').textContent = App.State.currentUser;
                
                // é¡¯ç¤ºéŠæˆ²æœƒè©± ID
                document.getElementById('sessionIdDisplay').textContent = App.State.gameSessionId;
                
                // å®šæœŸæ›´æ–°ç©å®¶åˆ—è¡¨
                App.Actions.updatePlayersList();
            },
            
            updatePreviousUsers: () => {
                const users = App.Storage.getUsers();
                const container = document.getElementById('previousUsersContainer');
                const list = document.getElementById('previousUsersList');
                
                if (users.length > 0) {
                    container.style.display = 'block';
                    list.innerHTML = '';
                    users.forEach(user => {
                        const btn = document.createElement('button');
                        btn.className = 'user-button';
                        btn.textContent = `ğŸ‘¤ ${user}`;
                        btn.onclick = () => App.Actions.loginAsUser(user);
                        list.appendChild(btn);
                    });
                }
            }
        },

        /* [æ¨¡çµ„ 7: CORE - é‚è¼¯å¼•æ“] */
        Core: {
            checkWin: () => {
                const currentUserData = App.State.participants[App.State.currentUser];
                if (!currentUserData) return;
                
                const currentLines = App.Utils.getLineCount(currentUserData.board, App.State.sharedDrawnNums);
                if (currentLines > currentUserData.winCount) {
                    currentUserData.winCount = currentLines;
                    alert(`æ­å–œ ${App.State.currentUser}ï¼ç›®å‰å·²é”æˆ ${currentLines} æ¢é€£ç·šï¼ğŸ§§`);
                    App.Storage.saveGame(App.State.currentUser, currentUserData);
                    
                    // åŒæ­¥åˆ°é›²ç«¯
                    if (firebaseInitialized) {
                        App.Firebase.syncToCloud(App.State.gameSessionId);
                    }
                }
            },
            
            syncGameState: () => {
                // ä¿å­˜å…±äº«ç‹€æ…‹åˆ°æœ¬åœ°å­˜å„²
                App.Storage.saveSharedState({
                    drawnNums: App.State.sharedDrawnNums,
                    drawPool: App.State.sharedDrawPool,
                    participants: App.State.participants
                });
                
                // ä¿å­˜ç©å®¶åˆ—è¡¨ï¼ˆæŒ‰ Session ID åˆ†é–‹å­˜å„²ï¼‰
                App.Storage.saveParticipants(App.State.participants, App.State.gameSessionId);
                
                // ä¿å­˜ç•¶å‰ç”¨æˆ¶çš„éŠæˆ²æ•¸æ“š
                if (App.State.currentUser && App.State.participants[App.State.currentUser]) {
                    App.Storage.saveGame(App.State.currentUser, App.State.participants[App.State.currentUser]);
                }
                
                // åŒæ­¥åˆ°é›²ç«¯
                if (firebaseInitialized && App.State.gameSessionId) {
                    App.Firebase.syncToCloud(App.State.gameSessionId);
                }
            }
        },

        /* [æ¨¡çµ„ 8: ACTIONS - ä½¿ç”¨è€…æ“ä½œ] */
        Actions: {
            initApp: () => {
                // åˆå§‹åŒ– Firebase
                initFirebase();
                
                // ä½¿ç”¨ sessionStorage å­˜å„²ç•¶å‰ç©å®¶ï¼ˆåˆ†é ç¨ç«‹ï¼‰
                // ä½¿ç”¨ localStorage å­˜å„²éŠæˆ²æœƒè©±ï¼ˆæ‰€æœ‰åˆ†é å…±äº«ï¼‰
                const savedUser = sessionStorage.getItem('bingo_current_user');
                const sessionId = localStorage.getItem('bingo_session_id');
                
                if (savedUser && sessionId) {
                    App.Actions.loginAsUser(savedUser, sessionId);
                } else {
                    App.UI.updatePreviousUsers();
                    App.UI.showLoginView();
                }
                
                // å®šæœŸåŒæ­¥éŠæˆ²ç‹€æ…‹ï¼ˆæ¯2ç§’åˆ°æœ¬åœ°ï¼Œé›²ç«¯æœƒè‡ªå‹•ä»¥äº‹ä»¶é©…å‹•æ–¹å¼åŒæ­¥ï¼‰
                setInterval(App.Core.syncGameState, 2000);
                
                // ç›£è½ localStorage è®ŠåŒ–ï¼ˆè·¨åˆ†é åŒæ­¥ï¼‰
                window.addEventListener('storage', (event) => {
                    // ç›£è½å…±äº«éŠæˆ²ç‹€æ…‹è®ŠåŒ–
                    if (event.key === 'bingo_shared_state') {
                        const remoteState = JSON.parse(event.newValue || '{"drawnNums":[], "drawPool":[], "participants":{}}');
                        // æª¢æŸ¥éŠæˆ²ç‹€æ…‹æ˜¯å¦æœ‰ä»»ä½•è®ŠåŒ–ï¼ˆåŒ…æ‹¬æ¸…ç©ºã€å¢åŠ ã€æ¸›å°‘ï¼‰
                        if (JSON.stringify(remoteState.drawnNums) !== JSON.stringify(App.State.sharedDrawnNums)) {
                            App.State.sharedDrawnNums = remoteState.drawnNums;
                            App.State.sharedDrawPool = remoteState.drawPool;
                            
                            // é‡æ–°æ¸²æŸ“æ­·å²ç´€éŒ„
                            App.Actions.renderHistory();
                            
                            // å¦‚æœè™Ÿç¢¼è¢«æ¸…ç©ºäº†ï¼Œæ¸…é™¤æ£‹ç›¤ä¸Šæ‰€æœ‰æ¨™è¨˜
                            if (remoteState.drawnNums.length === 0) {
                                document.querySelectorAll('.cell').forEach(cell => {
                                    if (!cell.classList.contains('free-cell')) {
                                        cell.classList.remove('marked');
                                    }
                                });
                            } else {
                                // æ¨™è¨˜æ£‹ç›¤ä¸Šçš„æ‰€æœ‰è™Ÿç¢¼
                                App.State.sharedDrawnNums.forEach(n => {
                                    document.querySelectorAll('.cell-num').forEach(s => { 
                                        if(s.textContent === App.Utils.fmt(n)) s.parentElement.classList.add('marked'); 
                                    });
                                });
                            }
                            
                            App.Core.checkWin();
                        }
                        
                        // åŒæ­¥ç©å®¶åˆ—è¡¨
                        if (remoteState.participants && JSON.stringify(remoteState.participants) !== JSON.stringify(App.State.participants)) {
                            App.State.participants = remoteState.participants;
                            App.Actions.updatePlayersList();
                        }
                    }
                    
                    // ç›£è½ç©å®¶åˆ—è¡¨è®ŠåŒ–ï¼ˆæŒ‰ Session ID åˆ†é–‹çš„é‘°åŒ™ï¼‰
                    if (event.key && event.key.startsWith('bingo_participants_')) {
                        // åªæ›´æ–°ç•¶å‰ session çš„ç©å®¶åˆ—è¡¨
                        if (App.State.gameSessionId && event.key === `bingo_participants_${App.State.gameSessionId}`) {
                            const remoteParticipants = JSON.parse(event.newValue || '{}');
                            if (JSON.stringify(remoteParticipants) !== JSON.stringify(App.State.participants)) {
                                App.State.participants = remoteParticipants;
                                App.Actions.updatePlayersList();
                            }
                        }
                    }
                });
                
                // ç›£è½é é¢å¸è¼‰äº‹ä»¶ï¼Œæ¸…ç†ç›£è½å™¨
                window.addEventListener('beforeunload', () => {
                    App.State.syncListeners.forEach(cleanup => cleanup());
                });
            },
            
            login: () => {
                const username = document.getElementById('usernameInput').value.trim();
                if (!username) {
                    alert('è«‹è¼¸å…¥ä½ çš„åç¨±');
                    return;
                }
                // æª¢æŸ¥æ˜¯å¦å·²æœ‰ç¾å­˜çš„éŠæˆ²æœƒè©±ï¼Œæ–°ç©å®¶è‡ªå‹•åŠ å…¥
                const existingSessionId = localStorage.getItem('bingo_session_id');
                const sessionId = existingSessionId || App.Utils.generateSessionId();
                App.Actions.loginAsUser(username, sessionId);
            },
            
            joinBySessionId: () => {
                const username = document.getElementById('usernameInput').value.trim();
                const sessionId = document.getElementById('sessionIdInput').value.trim();
                
                if (!username) {
                    alert('è«‹è¼¸å…¥ä½ çš„åç¨±');
                    return;
                }
                if (!sessionId) {
                    alert('è«‹è¼¸å…¥æœƒè©± ID');
                    return;
                }
                
                // é©—è­‰æœƒè©± ID æ ¼å¼
                if (!sessionId.startsWith('session_')) {
                    alert('æœƒè©± ID æ ¼å¼ä¸æ­£ç¢º (æ‡‰è©²ä»¥ session_ é–‹é ­)');
                    return;
                }
                
                // å¦‚æœ Firebase å·²åˆå§‹åŒ–ï¼Œå…ˆé©—è­‰ session æ˜¯å¦å­˜åœ¨
                if (firebaseInitialized) {
                    fetch(`${firebaseConfig.databaseURL}/games/${sessionId}.json`)
                        .then(res => res.json())
                        .then(data => {
                            if (data) {
                                console.log('âœ… æœƒè©±é©—è­‰æˆåŠŸ - å·²é€£æ¥åˆ°é ç«¯éŠæˆ²');
                            } else {
                                console.log('âš ï¸ Firebase ä¸­ç„¡æ­¤æœƒè©±ï¼Œä½†æœƒå‰µå»ºæ–°çš„é ç«¯æœƒè©±');
                            }
                            App.Actions.loginAsUser(username, sessionId);
                        })
                        .catch(err => {
                            console.log('âš ï¸ æœƒè©±é©—è­‰å¤±æ•—ï¼ˆé™ç´šç‚ºæœ¬åœ°æ¨¡å¼ï¼‰:', err.message);
                            App.Actions.loginAsUser(username, sessionId);
                        });
                } else {
                    // Firebase æœªåˆå§‹åŒ–æ™‚çš„è­¦å‘Šæç¤º
                    alert('âš ï¸ æç¤ºï¼šFirebase æœªåˆå§‹åŒ–ï¼Œè·¨ç€è¦½å™¨åŒæ­¥åŠŸèƒ½å¯èƒ½å—é™\n\nå¦‚éœ€è·¨ç€è¦½å™¨åŒæ­¥ï¼Œè«‹ç¢ºä¿åœ¨è¯ç¶²ç’°å¢ƒä¸‹ä½¿ç”¨');
                    App.Actions.loginAsUser(username, sessionId);
                }
            },
            
            loginAsUser: (username, sessionId = null) => {
                App.State.currentUser = username;
                App.State.gameSessionId = sessionId || App.Utils.generateSessionId();
                
                // ä½¿ç”¨ sessionStorage ä¿å­˜ç•¶å‰ç”¨æˆ¶ï¼ˆåˆ†é ç¨ç«‹ï¼‰
                sessionStorage.setItem('bingo_current_user', username);
                // ä½¿ç”¨ localStorage ä¿å­˜éŠæˆ²æœƒè©± IDï¼ˆæ‰€æœ‰åˆ†é å…±äº«ï¼‰
                localStorage.setItem('bingo_session_id', App.State.gameSessionId);
                App.Storage.saveUser(username);
                
                // åŠ è¼‰æ­¤ Session çš„ç©å®¶åˆ—è¡¨ï¼ˆå¿…é ˆå‚³å…¥ sessionIdï¼‰
                const allParticipants = App.Storage.loadParticipants(App.State.gameSessionId);
                if (Object.keys(allParticipants).length > 0) {
                    App.State.participants = allParticipants;
                }
                
                // åŠ è¼‰è©²ç”¨æˆ¶çš„éŠæˆ²æ•¸æ“šæˆ–å‰µå»ºæ–°éŠæˆ²
                const existingGame = App.Storage.loadGame(username);
                if (existingGame) {
                    App.State.participants[username] = existingGame;
                } else {
                    App.State.participants[username] = {
                        board: App.Utils.shuffle(Array.from({length: App.Config.MAX_NUM}, (_, i) => i+1)).slice(0, 24),
                        drawnNums: [],
                        winCount: 0
                    };
                }
                
                // åŠ è¼‰å…±äº«éŠæˆ²ç‹€æ…‹
                const sharedState = App.Storage.loadSharedState();
                App.State.sharedDrawPool = sharedState.drawPool.length > 0 ? 
                    sharedState.drawPool : 
                    App.Utils.shuffle(Array.from({length: App.Config.MAX_NUM}, (_, i) => i + 1));
                App.State.sharedDrawnNums = sharedState.drawnNums;
                
                // å¦‚æœä½¿ç”¨ Firebaseï¼Œå…ˆå¾ Firebase è®€å–ç¾æœ‰ç©å®¶ï¼ˆç¢ºä¿ä¸æœƒéºæ¼å…¶ä»–ç€è¦½å™¨çš„ç©å®¶ï¼‰
                if (firebaseInitialized) {
                    fetch(`${firebaseConfig.databaseURL}/games/${App.State.gameSessionId}/participants.json`)
                        .then(res => res.json())
                        .then(firebaseParticipants => {
                            if (firebaseParticipants) {
                                // åˆä½µ Firebase çš„ç©å®¶èˆ‡æœ¬åœ°ç©å®¶ï¼ˆæœ¬åœ°çš„æœƒè¦†è“‹ Firebase çš„åŒåç©å®¶ï¼‰
                                App.State.participants = { ...firebaseParticipants, ...App.State.participants };
                            }
                            // ä¿å­˜æ›´æ–°å¾Œçš„ç©å®¶åˆ—è¡¨åˆ° localStorageï¼ˆå‚³å…¥ sessionIdï¼‰
                            App.Storage.saveParticipants(App.State.participants, App.State.gameSessionId);
                            // ä¸Šå‚³åˆä½µå¾Œçš„å®Œæ•´ç©å®¶åˆ—è¡¨åˆ° Firebase
                            App.Firebase.syncToCloud(App.State.gameSessionId);
                            // å»¶é² 100ms å¾Œé‡æ–°æ¸²æŸ“ç©å®¶åˆ—è¡¨ï¼Œç¢ºä¿ UI èƒ½é¡¯ç¤ºå¾ Firebase åŠ è¼‰çš„ç©å®¶
                            setTimeout(() => {
                                App.Actions.updatePlayersList();
                            }, 100);
                        })
                        .catch(err => {
                            console.log('âš ï¸ Firebase è®€å–ç©å®¶å¤±æ•—ï¼ˆä½¿ç”¨æœ¬åœ°æ•¸æ“šï¼‰:', err.message);
                            // ä¿å­˜åˆ° localStorageï¼ˆå‚³å…¥ sessionIdï¼‰
                            App.Storage.saveParticipants(App.State.participants, App.State.gameSessionId);
                        });
                    
                    // è¨­ç½®å¯¦æ™‚ç›£è½ï¼ˆç”¨æ–¼å¾ŒçºŒçš„å¯¦æ™‚æ›´æ–°ï¼‰
                    App.Firebase.listenToGameChanges(App.State.gameSessionId);
                    App.Firebase.listenToPlayers(App.State.gameSessionId);
                } else {
                    // å¦‚æœæ²’æœ‰ Firebaseï¼Œåªä¿å­˜åˆ° localStorageï¼ˆå‚³å…¥ sessionIdï¼‰
                    App.Storage.saveParticipants(App.State.participants, App.State.gameSessionId);
                }
                
                App.UI.showGameView();
                App.Actions.renderBoard();
                App.Actions.renderHistory();
                App.Actions.updatePlayersList();
                // æ¨™è¨˜æ‰€æœ‰å·²æŠ½çš„è™Ÿç¢¼
                App.Actions.markDrawnNumbers();
                
                // å®šæœŸæ›´æ–°ç©å®¶åˆ—è¡¨
                if (!App.State.playerListInterval) {
                    App.State.playerListInterval = setInterval(() => {
                        App.Actions.updatePlayersList();
                    }, 1000);
                }
            },
            
            logout: () => {
                // æ¸…ç† Firebase ç›£è½å™¨
                App.State.syncListeners.forEach(cleanup => cleanup());
                App.State.syncListeners = [];
                
                // æ¸…ç†ç©å®¶åˆ—è¡¨æ›´æ–°çš„é–“éš”
                if (App.State.playerListInterval) {
                    clearInterval(App.State.playerListInterval);
                    App.State.playerListInterval = null;
                }
                
                // å¾åƒèˆ‡è€…åˆ—è¡¨ä¸­ç§»é™¤ç•¶å‰ç©å®¶
                if (App.State.currentUser && App.State.participants[App.State.currentUser]) {
                    delete App.State.participants[App.State.currentUser];
                    // ä¿å­˜æ›´æ–°å¾Œçš„åˆ—è¡¨ï¼ˆè§¸ç™¼å…¶ä»–åˆ†é å’Œå…¶ä»–ç€è¦½å™¨çš„åŒæ­¥ï¼‰
                    App.Storage.saveParticipants(App.State.participants, App.State.gameSessionId);
                    // åŒæ­¥åˆ°é›²ç«¯
                    if (firebaseInitialized) {
                        App.Firebase.syncToCloud(App.State.gameSessionId);
                    }
                }
                
                // æ¸…é™¤ç•¶å‰ç©å®¶çš„ sessionStorageï¼ˆä½†ä¿ç•™ localStorage çš„ sessionIdï¼‰
                sessionStorage.removeItem('bingo_current_user');
                App.State.currentUser = null;
                document.getElementById('usernameInput').value = '';
                App.UI.updatePreviousUsers();
                App.UI.showLoginView();
            },
            
            copySessionId: () => {
                const sessionId = App.State.gameSessionId;
                navigator.clipboard.writeText(sessionId).then(() => {
                    alert(`âœ… å·²è¤‡è£½æœƒè©± IDï¼\n\n${sessionId}\n\nåˆ†äº«çµ¦å…¶ä»–ç©å®¶å³å¯åŒæ­¥éŠæˆ²`);
                }).catch(() => {
                    // å‚™é¸æ–¹æ¡ˆ
                    const elem = document.getElementById('sessionIdDisplay');
                    elem.select();
                    document.execCommand('copy');
                    alert('âœ… å·²è¤‡è£½æœƒè©± IDï¼');
                });
            },
            
            renderBoard: () => {
                const b = document.getElementById('board'); 
                b.innerHTML = "";
                let myNums = App.State.participants[App.State.currentUser].board; 
                let k = 0;
                
                for(let i=0; i<25; i++) {
                    const c = document.createElement('div'); 
                    c.className = 'cell';
                    
                    if(i===12) { 
                        c.classList.add('free-cell','marked'); 
                        c.innerHTML = `<span style="color:#2e7d32; font-weight:900; font-size:29px; text-shadow:0 0 10px var(--gold);">ç™¼</span>`; 
                    } else { 
                        const n = myNums[k++]; 
                        c.innerHTML = `
                            <span class="cell-num">${App.Utils.fmt(n)}</span>
                            <svg class="stamp-svg" viewBox="0 0 100 100">
                                <circle cx="50" cy="50" r="45" fill="none" stroke="#ffcf33" stroke-width="4"/>
                                <text x="50" y="65" font-size="45" text-anchor="middle" fill="#ffcf33" font-weight="bold">ç™¼</text>
                            </svg>
                        `; 
                    }
                    b.appendChild(c);
                }
            },
            
            renderHistory: () => {
                document.getElementById('historyList').innerHTML = '';
                App.State.sharedDrawnNums.forEach(n => App.UI.updateHistory(n));
            },
            
            updatePlayersList: () => {
                const playersList = document.getElementById('playersList');
                const playersContainer = document.getElementById('playersContainer');
                const playerCount = document.getElementById('playerCount');
                
                // å¾ localStorage é‡æ–°è®€å–æœ€æ–°çš„ç©å®¶åˆ—è¡¨ï¼ˆç¢ºä¿åŒæ­¥å…¶ä»–åˆ†é å’Œå…¶ä»–ç€è¦½å™¨çš„è®ŠåŒ–ï¼‰
                const latestParticipants = App.Storage.loadParticipants(App.State.gameSessionId);
                if (Object.keys(latestParticipants).length > 0) {
                    App.State.participants = latestParticipants;
                }
                
                const players = Object.keys(App.State.participants);
                playerCount.textContent = players.length;
                
                if (players.length > 0) {
                    playersList.style.display = 'block';
                    playersContainer.innerHTML = '';
                    
                    players.forEach(player => {
                        const participantData = App.State.participants[player];
                        const lines = participantData.winCount || 0;
                        const playerItem = document.createElement('div');
                        playerItem.className = 'player-item';
                        playerItem.innerHTML = `
                            <span>ğŸ‘¤ ${player}</span>
                            <span style="color: #ffcf33;">ğŸ† ${lines} ç·š</span>
                        `;
                        playersContainer.appendChild(playerItem);
                    });
                }
            },
            
            markDrawnNumbers: () => {
                // æ¨™è¨˜æ£‹ç›¤ä¸Šæ‰€æœ‰å·²æŠ½çš„è™Ÿç¢¼
                App.State.sharedDrawnNums.forEach(n => {
                    document.querySelectorAll('.cell-num').forEach(s => { 
                        if(s.textContent === App.Utils.fmt(n)) {
                            s.parentElement.classList.add('marked'); 
                        }
                    });
                });
            },
            
            draw: () => {
                if(App.State.isAnimating || App.State.gameOver || App.State.sharedDrawPool.length === 0) return;
                
                App.State.isAnimating = true; 
                document.getElementById('drawBtn').disabled = true;

                let t = setInterval(() => { 
                    document.getElementById('displayNum').textContent = App.Utils.fmt(Math.floor(Math.random()*App.Config.MAX_NUM+1)); 
                }, 100);

                setTimeout(() => {
                    clearInterval(t);
                    const n = App.State.sharedDrawPool.shift();
                    App.State.sharedDrawnNums.push(n);
                    
                    document.getElementById('displayNum').textContent = App.Utils.fmt(n);
                    App.UI.updateHistory(n);
                    
                    // æ›´æ–°æ‰€æœ‰ç©å®¶çš„æ£‹ç›¤
                    document.querySelectorAll('.cell-num').forEach(s => { 
                        if(s.textContent === App.Utils.fmt(n)) s.parentElement.classList.add('marked'); 
                    });
                    
                    App.Core.checkWin();
                    App.Core.syncGameState();
                    
                    App.State.isAnimating = false; 
                    document.getElementById('drawBtn').disabled = false;
                    
                    // å¦‚æœçƒè™ŸæŠ½å®Œ
                    if (App.State.sharedDrawPool.length === 0) {
                        App.State.gameOver = true;
                        alert('æœ¬å±€å·²ç¶“å…¨éƒ¨é–‹å®Œï¼ğŸ‰');
                    }
                }, 2000); 
            },
            
            newGame: () => {
                // æ¸…ç†èˆŠç›£è½å™¨
                App.State.syncListeners.forEach(cleanup => cleanup());
                App.State.syncListeners = [];
                
                // é‡ç½®æ‰€æœ‰ç©å®¶çš„éŠæˆ²ç‹€æ…‹ï¼ˆæ–°éŠæˆ²æ™‚æ‰€æœ‰ç©å®¶ä¸€èµ·é‡æ–°é–‹å§‹ï¼‰
                Object.keys(App.State.participants).forEach(playerName => {
                    App.State.participants[playerName] = {
                        board: App.Utils.shuffle(Array.from({length: App.Config.MAX_NUM}, (_, i) => i+1)).slice(0, 24),
                        drawnNums: [],
                        winCount: 0
                    };
                });
                
                // é‡ç½®å…±äº«éŠæˆ²ç‹€æ…‹ï¼ˆä½†ä¿ç•™ç›¸åŒçš„ sessionIdï¼Œæ‰€æœ‰ç©å®¶ä¸€èµ·é‡æ–°é–‹å§‹ï¼‰
                App.State.sharedDrawPool = App.Utils.shuffle(Array.from({length: App.Config.MAX_NUM}, (_, i) => i + 1));
                App.State.sharedDrawnNums = [];
                App.State.isAnimating = false;
                App.State.gameOver = false;
                
                // ç«‹å³ä¿å­˜åˆ° localStorageï¼Œè§¸ç™¼è·¨åˆ†é åŒæ­¥
                App.Storage.saveSharedState({
                    drawnNums: App.State.sharedDrawnNums,
                    drawPool: App.State.sharedDrawPool,
                    participants: App.State.participants
                });
                
                // ä¿å­˜ç©å®¶åˆ—è¡¨ï¼ˆæŒ‰ Session ID åˆ†é–‹ï¼‰
                App.Storage.saveParticipants(App.State.participants, App.State.gameSessionId);
                
                App.Core.syncGameState();
                
                // é‡æ–°è¨­ç½® Firebase ç›£è½
                if (firebaseInitialized) {
                    App.Firebase.listenToGameChanges(App.State.gameSessionId);
                    App.Firebase.listenToPlayers(App.State.gameSessionId);
                }
                
                // é‡æ–°æ¸²æŸ“æ£‹ç›¤å’Œæ­·å²ç´€éŒ„
                App.Actions.renderBoard();
                // æ˜ç¢ºæ¸…ç©ºå·²é–‹è™Ÿç¢¼ç´€éŒ„
                document.getElementById('historyList').innerHTML = '';
                App.Actions.renderHistory();
                App.Actions.updatePlayersList();
                document.getElementById('displayNum').textContent = '?';
            }
        }
    };
    </script>
</body>
</html>