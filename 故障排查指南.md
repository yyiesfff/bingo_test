# 🔧 快速故障排查指南

## ⚡ 10 秒快速檢查

```
❌ 問題              ✅ 檢查項目
─────────────────────────────────────
遊戲打不開         1. 能打開 index.html?
                   2. 瀏覽器版本 (推薦 Chrome)

號碼無法同步       1. 檢查 localStorage 已啟用?
                   2. 兩個分頁是否同一 URL?

Firebase 連不上     1. API Key 是否正確?
                   2. Firebase 專案是否存在?
                   3. Database URL 是否正確?

手機無法連接電腦   1. 同 WiFi 網路?
                   2. 防火牆是否阻止 8000 port?
```

---

## 🔍 詳細檢查步驟

### 1️⃣ 遊戲無法打開

**症狀**: 雙擊 index.html 沒反應，或 404 錯誤

**解決方案**:
```
✅ 步驟 1: 確認 index.html 存在
cd c:\Users\FionaCheng\Downloads\bingo_test
dir index.html

✅ 步驟 2: 用不同方式打開
方式 A: 直接雙擊 index.html
方式 B: 右鍵 → 用瀏覽器打開 → Chrome
方式 C: 在瀏覽器地址欄貼上:
   file:///c:/Users/FionaCheng/Downloads/bingo_test/index.html

✅ 步驟 3: 更新瀏覽器
Chrome/Edge/Firefox 都要是最新版本
```

### 2️⃣ 同一電腦無法同步

**症狀**: 分頁 1 抽球，分頁 2 沒反應

**檢查程序**:
```
✅ F12 開發者工具 → Console 標籤
   看有無紅色錯誤?

✅ 檢查 localStorage
   console 執行: localStorage.getItem('bingo_shared_state')
   應該看到 JSON 格式的數據

✅ 檢查事件監聽
   是否有 storage 事件? (看 Console 日誌)

✅ 清除瀏覽器快取
   Ctrl+Shift+Delete → 清除所有數據
```

**常見原因**:
| 原因 | 解決 |
|------|------|
| 兩個分頁 URL 不同 | 複製貼上同一個 URL |
| 一個開文件檔，一個開 HTTP | 兩個都用文件檔，或都用 HTTP |
| 瀏覽器隱私模式 | 使用正常模式 |
| localStorage 被禁用 | 瀏覽器設定允許 localStorage |

### 3️⃣ 跨設備無法同步

**症狀**: Firebase 已配置，但手機看不到電腦的更新

**檢查步驟**:

```
✅ 1. 確認 Firebase 配置正確
   打開 index.html，F12 → Console
   執行: console.log(firebaseInitialized)
   應該顯示: true

✅ 2. 確認 Firebase 連線
   Console 執行:
   db.ref('.info/connected').on('value', s => console.log(s.val()))
   應該顯示: true

✅ 3. 確認數據上傳
   Firebase 控制台 → Database → 查看 games 節點
   應該看到: games/session_xxx/...

✅ 4. 確認雙向同步
   Console 執行:
   db.ref('games').on('value', d => console.log(d.val()))
   應該看到所有遊戲數據
```

**常見原因**:
| 原因 | 症狀 | 解決 |
|------|------|------|
| API Key 虛假 | 控制台無錯誤訊息，但數據不同步 | 複製真實的 API Key 到 firebaseConfig |
| 安全規則阻止 | 控制台有「Permission denied」 | 修改 Database Rules 允許讀寫 |
| 網路無法連 Firebase | 無法連接服務 | 確認網路連線，檢查防火牆 |
| 會話 ID 不同 | 數據顯示在不同的遊戲 | 確保兩個設備使用同一 sessionId |

### 4️⃣ 手機無法連接電腦

**症狀**: 手機輸入 192.168.1.X:8000 出現「無法連接」

**檢查步驟**:
```
✅ 步驟 1: 確認伺服器運行中
   Windows PowerShell 中看到:
   "Serving HTTP on ... port 8000"

✅ 步驟 2: 確認 IP 地址正確
   PowerShell 執行: ipconfig
   找 IPv4 Address (例如 192.168.1.100)
   手機輸入: http://192.168.1.100:8000

✅ 步驟 3: 確認同 WiFi 網路
   電腦和手機連接同一個 WiFi 路由器

✅ 步驟 4: 確認防火牆未阻止
   Windows Defender 防火牆 → 允許應用通過防火牆
   Python 應該被允許

✅ 步驟 5: 測試連線
   手機 ping 電腦: ping 192.168.1.100
   （如果支持）應該有回應
```

**快速測試**:
```
1. 電腦本機訪問:
   http://localhost:8000
   確認遊戲能打開 ✅

2. 手機訪問電腦:
   http://192.168.1.XXX:8000
   應該看到同樣的遊戲頁面 ✅
```

---

## 🐛 常見錯誤信息

### 錯誤 1: `Uncaught ReferenceError: firebase is not defined`

**原因**: Firebase SDK 沒有載入

**解決**.
```html
<!-- 檢查 index.html 的 head 標籤是否有 -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js"></script>
```

### 錯誤 2: `PERMISSION_DENIED: Permission denied`

**原因**: Firebase Database 安全規則不允許讀寫

**解決**:
1. Firebase 控制台 → Database → Rules 標籤
2. 改成:
```json
{
  "rules": {
    "games": {
      "$sessionId": {
        ".read": true,
        ".write": true
      }
    }
  }
}
```

### 錯誤 3: `Cross-Origin Request Blocked (CORS)`

**原因**: 跨域請求被阻止

**解決**:
- 確認使用的是同一個 URL 協議 (HTTP or HTTPS)
- 不要混用 file:// 和 http://

### 錯誤 4: `TypeError: Cannot read property 'xxx' of undefined`

**原因**: 變數未初始化，通常是異步加載問題

**解決**:
```javascript
// 在 Console 檢查
console.log(App.State);           // 是否有數據?
console.log(App.State.currentUser); // 是否已登入?
```

---

## 📊 性能診斷

### 檢查同步延遲

```javascript
// 在 Console 中執行
const start = Date.now();
App.Core.syncGameState();
console.log('同步耗時:', Date.now() - start, 'ms');
```

**預期結果**:
- LocalStorage: < 10 ms
- Firebase: 50-500 ms

### 檢查記憶體使用

```javascript
console.log('遊戲狀態大小:', 
  JSON.stringify(App.State).length, 'bytes'
);
```

**預期結果**: < 10 KB

### 監控事件監聽器

```javascript
// 檢查已註冊的監聽器數量
console.log('Firebase 監聽器:', App.State.syncListeners.length);

// 登出時應該清理，再次登入時應該等於玩家數
```

---

## 🔌 網路診斷

### 檢查 Firebase 連線

```javascript
// 在 Console 執行
db.ref('.info/connected').once('value').then(snapshot => {
  console.log('Firebase 連線狀態:', snapshot.val());
});
```

**結果**:
- `true`: 已連接 ✅
- `false`: 未連接 ❌

### 檢查 HTTP 伺服器

```powershell
# 測試本機連線
curl http://localhost:8000

# 測試遠程連線
curl http://192.168.1.100:8000
```

**結果**: 應該返回 HTML 內容

---

## 🎯 完整故障排查樹狀圖

```
問題: 遊戲無法同步
│
├─ 能打開 index.html?
│  ├─ NO → 檢查文件是否存在 + 瀏覽器版本
│  └─ YES ↓
│
├─ LocalStorage 同步工作?
│  ├─ 測試: 同一電腦不同分頁
│  ├─ NO → F12 檢查 Console 錯誤
│  └─ YES ✅
│
├─ 需要跨設備同步?
│  ├─ NO → 完成！享受遊戲
│  └─ YES ↓
│
├─ 已設定 Firebase?
│  ├─ NO → 遵循快速開始.md 設定
│  └─ YES ↓
│
├─ Firebase 信息正確?
│  ├─ 檢查: API Key, Database URL, Project ID
│  ├─ NO → 更正 firebaseConfig
│  └─ YES ↓
│
├─ 伺服器已啟動?
│  ├─ NO → python start_server.py
│  └─ YES ✅
│
├─ 手機和電腦同 WiFi?
│  ├─ NO → 連接相同 WiFi
│  └─ YES ✓
│
└─ 手機能訪問 192.168.1.X:8000?
   ├─ NO → 檢查防火牆
   └─ YES → 完成！跨設備同步工作 ✅✅✅
```

---

## 📋 完整檢查清單

在報告問題前，請確認:

- [ ] 瀏覽器是最新版本
- [ ] 已安裝最新的 Python (或使用 npx http-server)
- [ ] index.html 文件存在且完整
- [ ] 檢查過 Console 中的所有錯誤信息
- [ ] 已清除瀏覽器快取 (Ctrl+Shift+Delete)
- [ ] FirebaseConfig 信息已驗證正確
- [ ] 手機和電腦連接同一 WiFi
- [ ] 防火牆已允許 Python / 8000 port

---

## 💬 何時尋求幫助

如果以上都檢查過，但仍未解決，請準備以下信息:

1. **錯誤訊息**: F12 Console 的完整錯誤信息截圖
2. **配置信息**: firebaseConfig 中的 projectId
3. **環境信息**:
   - 操作系統 (Windows / MacOS / Linux)
   - 瀏覽器版本 (Chrome / Edge / Safari)
   - Network 連線方式 (WiFi / 有線)
4. **重現步驟**: 詳細描述如何再現問題

---

## 🚀 快速重啟

如果一切都亂套了，試試「核彈方案」:

```powershell
# 1. 關閉伺服器 (Ctrl+C)

# 2. 清除所有本地數據
# F12 Application → Storage → 清空所有

# 3. 重新啟動伺服器
python start_server.py

# 4. 重新進入遊戲（新的會話 ID）
http://localhost:8000
```

---

有問題？先檢查 Console 👇

按 **F12** → **Console** 標籤 → 查看是否有紅色錯誤訊息 🔴

祝你遊戲順利！🎉
